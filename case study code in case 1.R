############################################################################
# FUNCTIONS 
############################################################################

# Function to calculate the distance between the B-R profile of a drug/placebo and the ideal B-R profile
# v = value function (0 = least preferred, 1 = most preferred )
dist_br <- function(v, w) {
  return( sum((1/v)^w) )
}

dist_br2 <- function(v, w) {
  return( prod(((1/v)^w)  ) )
}

# Function to calculate the utility score using MCDA
# v = value function (0 = least preferred, 1 = most preferred )
us_br <- function(v, w) {
  return(sum(w*v))
}

us_br2 <- function(v, w) {
  return(prod(v^w))
}


us_br3_3 <- function(v, w) {
  return((v[1]*(2/3)*(w[1])) + (v[2]*(2/3)*(w[2])) + (v[3]*(2/3)*(w[3])) + (v[4]*(2/3)*(w[4])) +
           (v[1]*v[2]*((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[2]/3))) + (v[1]*v[3]*((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[3]/3))) +
           (v[1]*v[4]*((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[4]/3))) + (v[2]*v[3]*((2/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(w[3]/3))) +
           (v[2]*v[4]*((2/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(w[4]/3))) + (v[3]*v[4]*((2/3)*(1/3)*(w[3]/3)+(2/3)*(1/3)*(w[4]/3))) + 
           (v[1]*v[2]*v[3]*((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3))) + 
           (v[1]*v[2]*v[4]*((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[4]/3))) + 
           (v[1]*v[4]*v[3]*((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[4]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3))) + 
           (v[4]*v[2]*v[3]*((2/3)*(1/3)*(1/3)*(w[4]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3))) +
           (v[1]*v[2]*v[3]*v[4]*((1/3)*(1/3)*(1/3)*(w[1])+(1/3)*(1/3)*(1/3)*(w[2])+(1/3)*(1/3)*(1/3)*(w[3])+(1/3)*(1/3)*(1/3)*(w[4]))))
}

us_br3_4 <- function(v, w) {
  return((v[1]*(2/3)*(w[1])) + (v[2]*(2/3)*(w[2])) + (v[3]*(2/3)*(w[3])) + (v[4]*(2/3)*(w[4])) +
           (v[1]*v[2]*((2/3)*(1/3)*(w[1])+(2/3)*(1/3)*(w[2]))) + (v[1]*v[3]*((2/3)*(1/3)*(w[1])+(2/3)*(1/3)*(w[3]))) +
           (v[1]*v[4]*((2/3)*(1/3)*(w[1])+(2/3)*(1/3)*(w[4]))) + (v[2]*v[3]*((2/3)*(1/3)*(w[2])+(2/3)*(1/3)*(w[3]))) +
           (v[2]*v[4]*((2/3)*(1/3)*(w[2])+(2/3)*(1/3)*(w[4]))) + (v[3]*v[4]*((2/3)*(1/3)*(w[3])+(2/3)*(1/3)*(w[4]))) + 
           (v[1]*v[2]*v[3]*((2/3)*(1/3)*(1/3)*(w[1])+(2/3)*(1/3)*(1/3)*(w[2])+(2/3)*(1/3)*(1/3)*(w[3]))) + 
           (v[1]*v[2]*v[4]*((2/3)*(1/3)*(1/3)*(w[1])+(2/3)*(1/3)*(1/3)*(w[2])+(2/3)*(1/3)*(1/3)*(w[4]))) + 
           (v[1]*v[4]*v[3]*((2/3)*(1/3)*(1/3)*(w[1])+(2/3)*(1/3)*(1/3)*(w[4])+(2/3)*(1/3)*(1/3)*(w[3]))) + 
           (v[4]*v[2]*v[3]*((2/3)*(1/3)*(1/3)*(w[4])+(2/3)*(1/3)*(1/3)*(w[2])+(2/3)*(1/3)*(1/3)*(w[3]))) +
           (v[1]*v[2]*v[3]*v[4]*((1/3)*(1/3)*(1/3)*(w[1])+(1/3)*(1/3)*(1/3)*(w[2])+(1/3)*(1/3)*(1/3)*(w[3])+(1/3)*(1/3)*(1/3)*(w[4]))))
}
us_br3_5 <- function(v, w) {
  return((v[1]*(2/3)*(w[1])) + (v[2]*(2/3)*(w[2])) + (v[3]*(2/3)*(w[3])) + (v[4]*(2/3)*(w[4])) +
           (v[1]*v[2]*((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[2]/3))) + (v[1]*v[3]*((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[3]/3))) +
           (v[1]*v[4]*((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[4]/3))) + (v[2]*v[3]*((2/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(w[3]/3))) +
           (v[2]*v[4]*((2/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(w[4]/3))) + (v[3]*v[4]*((2/3)*(1/3)*(w[3]/3)+(2/3)*(1/3)*(w[4]/3))) + 
           (v[1]*v[2]*v[3]*((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3))) + 
           (v[1]*v[2]*v[4]*((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[4]/3))) + 
           (v[1]*v[4]*v[3]*((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[4]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3))) + 
           (v[4]*v[2]*v[3]*((2/3)*(1/3)*(1/3)*(w[4]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3))) +
           (v[1]*v[2]*v[3]*v[4]*((1/3)*(1/3)*(1/3)*(w[1])+(1/3)*(1/3)*(1/3)*(w[2])+(1/3)*(1/3)*(1/3)*(w[3])+(1/3)*(1/3)*(1/3)*(w[4]))))
}
dist_br3_10 <- function(v, w) {
  return(((1/v[1])^(w[1]))+ ((1/v[2])^(w[2]))+((1/v[3])^(w[3]))+((1/v[4])^(w[4]))+
           (((1/v[1])*(1/v[2]))^(0.1/11))+(((1/v[1])*(1/v[3]))^(0.1/11))+(((1/v[1])*(1/v[4]))^(0.1/11))+
           (((1/v[2])*(1/v[3]))^(0.1/11))+(((1/v[2])*(1/v[4]))^(0.1/11))+(((1/v[3])*(1/v[4]))^(0.1/11))+
           (((1/v[1])*(1/v[2])*(1/v[3]))^(0.1/11))+(((1/v[1])*(1/v[2])*(1/v[4]))^(0.1/11))+
           (((1/v[1])*(1/v[3])*(1/v[4]))^(0.1/11))+(((1/v[2])*(1/v[3])*(1/v[4]))^(0.1/11))+
           (((1/v[1])*(1/v[2])*(1/v[3])*(1/v[4]))^(0.1/11)))
}

dist_br3_4 <- function(v, w) {
  return(((1/v[1])^((2/3)*(w[1]))) + ((1/v[2])^((2/3)*(w[2]))) + ((1/v[3])^((2/3)*(w[3]))) + ((1/v[4])^((2/3)*(w[4]))) +
           (((1/v[1])*(1/v[2]))^(((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[2]/3)))) + (((1/v[1])*(1/v[3]))^(((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[3]/3)))) +
           (((1/v[1])*(1/v[4]))^(((2/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(w[4]/3)))) + (((1/v[2])*(1/v[3]))^(((2/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(w[3]/3)))) +
           (((1/v[2])*(1/v[4]))^(((2/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(w[4]/3)))) + (((1/v[3])*(1/v[4]))^(((2/3)*(1/3)*(w[3]/3)+(2/3)*(1/3)*(w[4]/3)))) + 
           (((1/v[1])*(1/v[2])*(1/v[3]))^(((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3)))) + 
           (((1/v[1])*(1/v[2])*(1/v[4]))^(((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[4]/3)))) + 
           (((1/v[1])*(1/v[4])*(1/v[3]))^(((2/3)*(1/3)*(1/3)*(w[1]/3)+(2/3)*(1/3)*(1/3)*(w[4]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3)))) + 
           (((1/v[4])*(1/v[2])*(1/v[3]))^(((2/3)*(1/3)*(1/3)*(w[4]/3)+(2/3)*(1/3)*(1/3)*(w[2]/3)+(2/3)*(1/3)*(1/3)*(w[3]/3)))) +
           (((1/v[1])*(1/v[2])*(1/v[3])*(1/v[4]))^(((1/3)*(1/3)*(1/3)*(w[1])+(1/3)*(1/3)*(1/3)*(w[2])+(1/3)*(1/3)*(1/3)*(w[3])+(1/3)*(1/3)*(1/3)*(w[4])))))
}
der_mid<-function(w){
  y<-(w/(1-w)) * 2 ^(2*w-1)
  return(y)
}


search<-function(target){
  y<-der_mid(w=seq(0.0001,1,0.0001))
  z<-which.min(abs(y-target))
  we<-seq(0.0001,1,0.0001)[z]
  return(we)
}


############################################################################
# DATA INPUT 
############################################################################

set.seed(2019)

nsim=100000 # nb of simulations to obtain the posterior distributions

# CRITERIA
names=c("Cure","Hepatic","Cardiac","Visual","Syncope")
#v,f,p
a=matrix(c(51, 45, 37,
           40,  22, 8,
           22,  15, 14,
           10,   7, 1),ncol=4,byrow=FALSE)

b=matrix(c(47,  55, 64,
           60, 80, 94,
           78, 87, 88,
           90, 95, 101),ncol=4,byrow=FALSE)



# "Direction" of the endpoints: 1 = the higher the better, 0 = the lower the better
dir = c(1, 0, 0, 0)


# c1, c2 = best and worst values for the partial value functions
#v
c1 = c(0.28,0.04,0.08,0.00)
c2 = c(0.63,0.50,0.31,0.17)

weight=c(0.25, 0.25, 0.25, 0.25)

map_weight<-vector(length=length(weight)) 

for (i in 1:length(map_weight)){
  map_weight[i]<-search(target=weight[i]/(1-weight[i]))
}

Ntrt=3
Nendpt=4


value1=((c1-(a/(a+b))[1,])/(c1-c2))*dir + ((c2-(a/(a+b))[1,])/(c2-c1))*(1-dir)
value2=((c1-(a/(a+b))[2,])/(c1-c2))*dir + ((c2-(a/(a+b))[2,])/(c2-c1))*(1-dir)

#############
# RESULTS   #
#############


# Declaration of the objects
############################
pi = array(0, c(nsim, Ntrt, Nendpt))
value = array(0, c(nsim, Ntrt, Nendpt))
br_d = array(0, c(nsim, Ntrt))
br_d2 = array(0, c(nsim, Ntrt))
br_d3 = array(0, c(nsim, Ntrt))
br_d_sensitivity = array(0, c(nsim, Ntrt))
br_u =array(0, c(nsim, Ntrt))
br_u2 =array(0, c(nsim, Ntrt))
br_u3 =array(0, c(nsim, Ntrt))
#br_u3_2 =array(0, c(nsim, Ntrt))
br_u3_5 =array(0, c(nsim, Ntrt))
br_u3_4 =array(0, c(nsim, Ntrt))
br_d3_4 =array(0, c(nsim, Ntrt))

# Criterion distributions & Partial value functions & Distance & Utility
############################################################################
for (i in 1:Ntrt) {
  for(j in 1:Nendpt) {
    pi[,i,j]=rbeta(nsim, a[i,j], b[i,j])
    value[,i,j] <- pmin(pmax( ((pi[,i,j]-c1[j])/(c2[j]-c1[j]))*dir[j] + ((c2[j]-pi[,i,j])/(c2[j]-c1[j]))*(1-dir[j]), 0.00001 ),0.9999) ;
  }
  br_d[,i] <- apply(value[,i,], 1, dist_br, w=map_weight)
  br_d2[,i] <- apply(value[,i,], 1, dist_br2, w=weight)
  br_d_sensitivity[,i] <- apply(value[,i,], 1, dist_br, w=weight)
  br_u[,i] <- apply(value[,i,], 1, us_br, w=weight)
  br_u2[,i] <- apply(value[,i,], 1, us_br2, w=weight)
  #br_u3[,i] <- apply(value[,i,], 1, us_br3, w=weight)
  #br_u3_2[,i] <- apply(value[,i,], 1, us_br3_2, w=map_weight2)
  br_u3_5[,i] <- apply(value[,i,], 1, us_br3_5, w=weight)
  br_u3_4[,i] <- apply(value[,i,], 1, us_br3_4, w=weight)
  br_d3_4[,i] <- apply(value[,i,], 1, dist_br3_4, w=map_weight)

}



mean(br_u[,1]>br_u[,2])
mean(br_u2[,1]>br_u2[,2])
mean(br_u3_4[,1]>br_u3_4[,2])
mean(br_u3_5[,1]>br_u3_5[,2])
mean(br_d[,1]<br_d[,2])
mean(br_d2[,1]<br_d2[,2])
mean(br_d3_4[,1]<br_d3_4[,2])
"mean(br_d_sensitivity[,1]<br_d_sensitivity[,2])
mean(br_u[,1]<br_u[,2])
mean(br_u2[,1]<br_u2[,2])
mean(br_u3[,1]<br_u3[,2])
mean(br_d[,1]>br_d[,2])
mean(br_d2[,1]>br_d2[,2])
mean(br_d_sensitivity[,1]>br_d_sensitivity[,2])"



mean(br_u[,1]>br_u[,3])
mean(br_u2[,1]>br_u2[,3])
mean(br_u3_4[,1]>br_u3_4[,3])
mean(br_u3_5[,1]>br_u3_5[,3])
mean(br_d[,1]<br_d[,3])
mean(br_d2[,1]<br_d2[,3])
mean(br_d3_4[,1]<br_d3_4[,3])
"mean(br_d_sensitivity[,1]<br_d_sensitivity[,3])
mean(br_u[,1]<br_u[,3])
mean(br_u2[,1]<br_u2[,3])
mean(br_u3[,1]<br_u3[,3])
mean(br_d[,1]>br_d[,3])
mean(br_d2[,1]>br_d2[,3])
mean(br_d_sensitivity[,1]>br_d_sensitivity[,3])"



mean(br_u[,2]>br_u[,3])
mean(br_u2[,2]>br_u2[,3])
mean(br_u3_4[,2]>br_u3_4[,3])
mean(br_u3_5[,2]>br_u3_5[,3])
mean(br_d[,2]<br_d[,3])
mean(br_d2[,2]<br_d2[,3])
mean(br_d3_4[,2]<br_d3_4[,3])